%define with_python2 %{?_with_python2:1}%{!?_with_python2:0}

Summary: OpenTestPoint
Name: opentestpoint
Version: @VERSION@
Release: 1%{?dist}
License: BSD
Group: Applications/System
URL: https://github.com/adjacentlink/opentestpoint
Source0: %{name}-%{version}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
Requires: libxml2 protobuf libuuid 
BuildRequires: libxml2-devel protobuf-devel libuuid-devel sqlite-devel

%define with_old_depends 0%{?el7}
%define with_pathfix 0%{!?el7}

%if 0%{?with_python2}
%if %{with_old_depends}
Requires: python
BuildRequires: python-devel
%define use_python_package python-opentestpoint
%define use_python_setuptools python-setuptools
%define use_python_protobuf protobuf-python
%define use_python_zmq python-zmq
%define use_python_devel python-devel
%define use_python_six python-six
%define use_python_sitelib %{python_sitelib}
%define use_python_sitearch %{python_sitearch}
%else
Requires: python2
BuildRequires: python2-devel
%define use_python_package python2-opentestpoint
%define use_python_setuptools python2-setuptools
%define use_python_protobuf python2-protobuf
%define use_python_zmq python2-zmq
%define use_python_devel python2-devel
%define use_python_six python2-six
%define use_python_sitelib %{python2_sitelib}
%define use_python_sitearch %{python2_sitearch}
%endif
%define use_python_version %{python2_version}
%define use_python_major_version 2
%else
Requires: python3
BuildRequires: python3-devel
%define use_python_package python3-opentestpoint
%define use_python_setuptools python3-setuptools
%define use_python_protobuf python3-protobuf
%define use_python_zmq python3-zmq
%define use_python_devel python3-devel
%define use_python_six python3-six
%define use_python_sitelib %{python3_sitelib}
%define use_python_sitearch %{python3_sitearch}
%define use_python_version %{python3_version}
%define use_python_major_version 3
%endif

Requires: zeromq
BuildRequires: zeromq-devel
Vendor: Adjacent Link LLC

%description
OpenTestPoint

%package devel
Summary: OpenTestPoint Headers
Group: Development/Libraries
Requires: protobuf-devel libuuid-devel opentestpoint
Requires: %{use_python_devel}

%if 0%{?el6}
Requires: zeromq3-devel
%else
Requires: zeromq-devel
%endif

%description devel
OpenTestPoint Headers

%package -n %{use_python_package}
Requires: %{use_python_zmq} %{use_python_setuptools} %{use_python_protobuf} %{use_python_six}
Summary: OpenTestPoint Python modules
Group: Development/Libraries

%description -n %{use_python_package}
OpenTestPoint Python modules

%prep
%setup -q

%build
%if 0%{?with_python2}
%configure --with-python2
%else
%configure
%endif
make

%install
make DESTDIR=${RPM_BUILD_ROOT} install
find ${RPM_BUILD_ROOT} -name '*.a' -exec rm '{}'  \;
find ${RPM_BUILD_ROOT} -name '*.la' -exec rm '{}' \;
%if 0%{?el6}
find  ${RPM_BUILD_ROOT} -name "namespace_packages.txt" -exec sh -c "echo otestpoint > {}" \;
%endif
mv %{buildroot}/%{_bindir}/otestpoint-discover %{buildroot}/%{_bindir}/otestpoint-discover-%{use_python_version}
mv %{buildroot}/%{_bindir}/otestpoint-dump %{buildroot}/%{_bindir}/otestpoint-dump-%{use_python_version}
mv %{buildroot}/%{_bindir}/otestpoint-filter %{buildroot}/%{_bindir}/otestpoint-filter-%{use_python_version}
mv %{buildroot}/%{_bindir}/otestpoint-print %{buildroot}/%{_bindir}/otestpoint-print-%{use_python_version}

ln -s otestpoint-discover-%{use_python_version} %{buildroot}/%{_bindir}/otestpoint-discover-%{use_python_major_version}
ln -s otestpoint-dump-%{use_python_version} %{buildroot}/%{_bindir}/otestpoint-dump-%{use_python_major_version}
ln -s otestpoint-filter-%{use_python_version} %{buildroot}/%{_bindir}/otestpoint-filter-%{use_python_major_version}
ln -s otestpoint-print-%{use_python_version} %{buildroot}/%{_bindir}/otestpoint-print-%{use_python_major_version}

ln -s otestpoint-discover-%{use_python_major_version} %{buildroot}/%{_bindir}/otestpoint-discover
ln -s otestpoint-dump-%{use_python_major_version} %{buildroot}/%{_bindir}/otestpoint-dump
ln -s otestpoint-filter-%{use_python_major_version} %{buildroot}/%{_bindir}/otestpoint-filter
ln -s otestpoint-print-%{use_python_major_version} %{buildroot}/%{_bindir}/otestpoint-print

%if 0%{?with_python2}
%if %{with_pathfix}
pathfix.py -pni "%{__python2} %{py2_shbang_opts}" %{buildroot}%{_bindir}/*-%{python2_version}
%endif
%else
pathfix.py -pni "%{__python3} %{py3_shbang_opts}" %{buildroot}%{_bindir}/*-%{python3_version}
%endif

%clean
rm -rf $RPM_BUILD_ROOT

%post
/sbin/ldconfig

%postun
/sbin/ldconfig

%files
%defattr(-,root,root,-)
%{_libdir}/*.so
%{_bindir}/otestpoint-broker
%{_bindir}/otestpoint-probe
%{_bindir}/otestpoint-recorder
%{_bindir}/otestpointd

%doc AUTHORS
%doc COPYING
%doc NEWS
%doc README
%doc INSTALL

%files devel
%defattr(-, root, root)
%{_includedir}/*
%{_libdir}/pkgconfig

%files -n %{use_python_package}
%defattr(-,root,root)
%{use_python_sitearch}/otestpoint*
%{use_python_sitearch}/opentestpoint*
%{use_python_sitelib}/otestpoint*
%{use_python_sitelib}/opentestpoint*
%{_bindir}/otestpoint-discover
%{_bindir}/otestpoint-dump
%{_bindir}/otestpoint-filter
%{_bindir}/otestpoint-print
%{_bindir}/otestpoint-discover-%{use_python_version}
%{_bindir}/otestpoint-dump-%{use_python_version}
%{_bindir}/otestpoint-filter-%{use_python_version}
%{_bindir}/otestpoint-print-%{use_python_version}
%{_bindir}/otestpoint-discover-%{use_python_major_version}
%{_bindir}/otestpoint-dump-%{use_python_major_version}
%{_bindir}/otestpoint-filter-%{use_python_major_version}
%{_bindir}/otestpoint-print-%{use_python_major_version}
